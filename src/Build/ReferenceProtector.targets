<?xml version="1.0" encoding="utf-8"?>

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="CollectAllReferences" AssemblyFile="$(ReferenceProtectorTaskAssembly)" Condition="'$(EnableReferenceProtector)' != 'false'" />

  <PropertyGroup>
    <CoreCompileDependsOn>$(CoreCompileDependsOn);CollectDeclaredReferencesReferenceProtector</CoreCompileDependsOn>
  </PropertyGroup>

  <Target Name="CollectDeclaredReferencesReferenceProtector" DependsOnTargets="ResolveAssemblyReferences;PrepareProjectReferences" Condition="'$(EnableReferenceProtector)' != 'false'">
    <PropertyGroup>
      <_ReferenceProtectorDeclaredReferences>$(IntermediateOutputPath)\_ReferenceProtector_DeclaredReferences.tsv</_ReferenceProtectorDeclaredReferences>
    </PropertyGroup>
    <ItemGroup>
      <_ReferenceProtectorReferences Include="@(Reference)" />
    </ItemGroup>

    <CollectAllReferences
      OutputFile="$(_ReferenceProtectorDeclaredReferences)"
      ProjectReferences="@(ProjectReference)"
      MSBuildProjectFile="$(MSBuildProjectFullPath)" />

    <ItemGroup>
      <AdditionalFiles Include="$(_ReferenceProtectorDeclaredReferences)" Visible="false" Condition="Exists('$(_ReferenceProtectorDeclaredReferences)')" />
      <AdditionalFiles Include="$(DependencyRulesFile)" Visible="false" Condition="Exists('$(DependencyRulesFile)')" />
      <FileWrites Include="$(_ReferenceProtectorDeclaredReferences)" />
    </ItemGroup>
  </Target>
</Project>